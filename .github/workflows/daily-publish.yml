# ë§¤ì¼ ì˜ˆì•½ ë°œí–‰ + ì¹´íŽ˜24 FTP ìžë™ ì—…ë¡œë“œ
# - Playwrightë¡œ í¼ì¦ ì´ë¯¸ì§€Â·ê¸€ ìƒì„± í›„ FTPë¡œ ì¹´íŽ˜24ì— ì—…ë¡œë“œ
name: Daily publish and FTP deploy

on:
  schedule:
    # ë§¤ì¼ 00:00 UTC = í•œêµ­ì‹œê°„ 09:00 (í•„ìš” ì‹œ ìˆ˜ì •)
    - cron: '0 0 * * *'
  workflow_dispatch:
    inputs:
      test_date:
        description: 'í…ŒìŠ¤íŠ¸ìš© ë°œí–‰ì¼ (YYYY-MM-DD). ë¹„ìš°ë©´ ì˜¤ëŠ˜ ë‚ ì§œ. SEO ìœ„í•´ í…ŒìŠ¤íŠ¸ ì‹œ ê³¼ê±° ë‚ ì§œ ê¶Œìž¥'
        required: false
        type: string

jobs:
  publish:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Playwright and Chromium
        run: |
          pip install playwright
          playwright install chromium
          playwright install-deps

      - name: Run publish script
        run: |
          if [ -n "${{ inputs.test_date }}" ]; then
            echo "ðŸ§ª í…ŒìŠ¤íŠ¸ ëª¨ë“œ: ë°œí–‰ì¼ ${{ inputs.test_date }}"
            python3 auto_publish_with_images.py --date=${{ inputs.test_date }}
          else
            python3 auto_publish_with_images.py
          fi

      - name: List generated files (ì´ë¯¸ì§€/ê¸€ ìƒì„± í™•ì¸)
        run: |
          echo "=== posts/ ==="
          ls -la posts/ 2>/dev/null || true
          echo "=== images/puzzles/ ==="
          ls -la images/puzzles/ 2>/dev/null || true

      - name: Prepare upload folder (no .git)
        run: |
          mkdir -p upload
          rsync -a \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='.venv' \
            --exclude='upload' \
            --exclude='**/__pycache__' \
            --exclude='logs' \
            --exclude='*.py' \
            ./ upload/

      - name: FTP Deploy to Cafe24 (lftp)
        env:
          FTP_SERVER: ${{ secrets.FTP_SERVER }}
          FTP_USER: ${{ secrets.FTP_USERNAME }}
          FTP_PASS: ${{ secrets.FTP_PASSWORD }}
        run: |
          sudo apt-get update -qq && sudo apt-get install -y -qq lftp
          cd upload
          lftp -c "
            set ftp:ssl-allow no
            set ssl:verify-certificate no
            set ftp:passive on
            set net:timeout 60
            set net:max-retries 5
            set net:reconnect-interval-base 5
            set net:reconnect-interval-multiplier 1
            open -u $FTP_USER,$FTP_PASS $FTP_SERVER
            lcd .
            mirror --reverse --verbose .
            bye
          "
